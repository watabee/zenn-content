---
title: "ã€React Nativeã€‘Native UI Components ã§ Android ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹"
emoji: "ğŸ¤–"
type: "tech"
topics:
  - "android"
  - "reactnative"
published: true
published_at: "2022-12-01 10:15"
publication_name: "aldagram_tech"
---

ã“ã‚“ã«ã¡ã¯ï¼ã‚¢ãƒ«ãƒ€ã‚°ãƒ©ãƒ ã§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ã‚‹æ¸¡é‚Šã§ã™ï¼

React Native ã§ã¯ [Native UI Components](https://reactnative.dev/docs/native-components-android) ã§ Android ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»Šå›ã“ã®æ©Ÿèƒ½ã«ã¤ã„ã¦æ˜ã‚Šä¸‹ã’ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ï¼

ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ [ã“ã¡ã‚‰](https://github.com/watabee/NativeUiComponentSample) ã«å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

â€» [Fabric](https://reactnative.dev/docs/the-new-architecture/pillars-fabric-components) ã«ã¤ã„ã¦ã¯ä»Šå›ã®è¨˜äº‹ã§ã¯æ‰±ã„ã¾ã›ã‚“ã€‚

# Native UI Components

Native UI Components ã§ã§ãã‚‹ã“ã¨ã¯å¤§åˆ¥ã—ã¦ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

1. Android ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã‚’ React Native ã§è¡¨ç¤ºã§ãã‚‹
2. React Native ã‹ã‚‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã‚‹
3. ãƒã‚¤ãƒ†ã‚£ãƒ–ã‹ã‚‰ React Native ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¼ãˆã‚‹ã“ã¨ãŒã§ãã‚‹
4. React Native ã‹ã‚‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¼ãˆã‚‹ã“ã¨ãŒã§ãã‚‹

ä»Šå› `RainbowView` ã¨ã„ã†ä¸€å®šæ™‚é–“ã”ã¨ã«èƒŒæ™¯è‰²ãŒè™¹è‰²ã«å¤‰åŒ–ã™ã‚‹ãƒ“ãƒ¥ãƒ¼ã‚’ Android ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã¨ã—ã¦ä½œæˆã—ã€ãã‚Œã‚’è¡¨ç¤ºã™ã‚‹ä¾‹ã‚’å…ƒã«é †ã‚’è¿½ã£ã¦è¦‹ã¦ã„ãã¾ã™ã€‚

# 1. Android ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã‚’ React Native ã§è¡¨ç¤º

ã¾ãšã¯ Android å´ã®ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚
ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã« `ViewManager` ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
å¤§æŠµã®å ´åˆã¯ä»¥ä¸‹ã®2ã¤ã®ã„ãšã‚Œã‹ã‚’ç¶™æ‰¿ã™ã‚Œã°å•é¡Œãªã„ã¯ãšã§ã™ã€‚

- `SimpleViewManager`
- `ViewGroupManager`

`ViewGroupManager` ã¯ Android ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã® `ViewGroup` ã‚’ç¶™æ‰¿ã—ãŸãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã«ä½¿ç”¨ã—ã¾ã™ã€‚ ã“ã¡ã‚‰ã‚’ä½¿ã†ã“ã¨ã§ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã®ã‚ˆã†ã« React Native ã«ãŠã„ã¦ `children` ã®è¦ç´ ã‚’ add ã—ã¦è¡¨ç¤ºã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript
// NativeViewGroup ã¯ ViewGroupManager ã‚’ä½¿ã£ãŸãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼.
<NativeViewGroup
  ...
>
    <View ... >
    <View ... >
    <View ... >
</NativeViewGroup>
```

ä¸Šè¨˜ã®ã‚ˆã†ã« children ãŒå¿…è¦ãªã„å ´åˆã¯ `SimpleViewManager` ã‚’ä½¿ã„ã¾ã™ã€‚

`SimpleViewManager` ã‚‚ `ViewGroupManager` ã‚‚å…±é€šã—ã¦ã€`getName()` ã¨ `createViewInstance()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»Šå› `RainbowView` ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã« `SimpleViewManager` ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¾ã™ã€‚

```kotlin:RainbowViewManager.kt
class RainbowViewManager : SimpleViewManager<RainbowView>() {
    override fun getName(): String {
        // React Native ã§å‚ç…§ã™ã‚‹éš›ã®åå‰.
        return "RainbowView"
    }

    override fun createViewInstance(reactContext: ThemedReactContext): RainbowView {
        // è¡¨ç¤ºã—ãŸã„ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹.
        return RainbowView(reactContext)
    }
}
```

`ReactPackage` ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã® `createViewManagers()` ãƒ¡ã‚½ãƒƒãƒ‰ã§ `RainbowViewManager` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

```kotlin:MyAppPackage.kt
class MyAppPackage : ReactPackage {
    override fun createNativeModules(reactContext: ReactApplicationContext) = 
        emptyList<NativeModule>()

    override fun createViewManagers(reactContext: ReactApplicationContext) =
        // RainbowViewManager ã‚’ç™»éŒ²ã™ã‚‹.
        mutableListOf(RainbowViewManager())
}
```

ä¸Šè¨˜ã® `MyAppPackage` ã¯ã€€`MainApplication` ã® `ReactNativeHost` ã«ç™»éŒ²ã—ã¾ã™ã€‚

```java:MainApplication.java
public class MainApplication extends Application implements ReactApplication {

    private final ReactNativeHost mReactNativeHost = new ReactNativeHost(this) {
        ...
        @Override
        protected List<ReactPackage> getPackages() {
            List<ReactPackage> packages = new PackageList(this).getPackages();
            packages.add(new MyAppPackage()); // <- è¿½åŠ 
            return packages;
        }
        ...
    };
  
    ...
```

ã“ã‚Œã§è¡¨ç¤ºã™ã‚‹æº–å‚™ã¯ã§ããŸã®ã§ã€React Native å´ã§è¡¨ç¤ºã•ã›ã¾ã™ã€‚
ã¾ãšã¯ `RainbowView` ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã« `requireNativeComponent` é–¢æ•°ã‚’ä½¿ã„ã¾ã™ã€‚ å¼•æ•°ã«ã¯ `RainbowViewManager` ã® `getName()` ãƒ¡ã‚½ãƒƒãƒ‰ã§è¿”ã—ã¦ã„ã‚‹æ–‡å­—åˆ—ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```typescript:RainbowView.ts
import { requireNativeComponent, ViewProps } from 'react-native'

type RainbowViewProps = Readonly<ViewProps>

export const RainbowView =
  requireNativeComponent<RainbowViewProps>('RainbowView')
```

ã“ã‚Œã§ `RainbowView` ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```typescript:App.tsx
const App = () => <RainbowView style={styles.rainbow} />

const styles = StyleSheet.create({
  rainbow: {
    flex: 1
  }
})
```

# 2. React Native ã‹ã‚‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã™

å…ˆã»ã©ã® `RainbowView` ã¯1ç§’ã”ã¨ã«è‰²ãŒå¤‰ã‚ã‚‹ãƒ“ãƒ¥ãƒ¼ã¨ã—ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ è‰²ãŒå¤‰ã‚ã‚‹æ™‚é–“ã‚’ React Native ã‹ã‚‰è¨­å®šã•ã›ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã™ã€‚

Android å´ã§ React Native ã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ãŸã‚ã«ã¯ã€`ViewManager` ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã§ `@ReactProp` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒä»˜ã„ãŸã‚»ãƒƒã‚¿ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»Šå›ã®å ´åˆã ã¨ `RainbowViewManager` ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚»ãƒƒã‚¿ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```kotlin:RainbowViewManager.kt
class RainbowViewManager : SimpleViewManager<RainbowView>() {
    ...
  
    @ReactProp(name = "updateMillis")
    fun setUpdateMillis(view: RainbowView, updateMillis: Int) {
        view.updateMillis = updateMillis
    }
}
```

`@ReactProp` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ `name` ã‚’å¿…é ˆã§æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ã“ã“ã§å®šç¾©ã—ãŸåå‰ã¯ React Native ã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã™æ™‚ã®åå‰ã«ãªã‚Šã¾ã™ã€‚

ã‚»ãƒƒã‚¿ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã€ç¬¬ä¸€å¼•æ•°ã«ã¯å¯¾è±¡ã®ãƒ“ãƒ¥ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆä»Šå›ã®ä¾‹ã ã¨ `RainbowView`ï¼‰ã€ç¬¬äºŒå¼•æ•°ã«ã¯å—ã‘å–ã‚ŠãŸã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã—ã¾ã™ã€‚
ç¬¬äºŒå¼•æ•°ã«æŒ‡å®šã§ãã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

- Java ã®å ´åˆ
  - `boolean`ã€`int`ã€`float`ã€`double`ã€`String`ã€`Boolean`ã€`Integer`ã€`ReadableArray`ã€`ReadableMap`
- Kotlin ã®å ´åˆ
  - `Boolean`ã€`Int`ã€`Float`ã€`Double`ã€`String`ã€`ReadableArray`ã€`ReadableMap`

ã¾ãŸã€€`@ReactProp` ã«ã¯ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã«å¯¾ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¦ãŠãã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```kotlin
@ReactProp(name = "updateMillis", defaultInt = 1000)
```

ç¶šã„ã¦ React Native å´ã‚’å¯¾å¿œã—ã¾ã™ã€‚ å…ˆã»ã©å®šç¾©ã—ãŸ `RainbowViewProps` ã« `updateMillis` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```typescript:RainbowView.ts
type RainbowViewProps = Readonly<{
  updateMillis?: number
} & ViewProps>

export const RainbowView =
  requireNativeComponent<RainbowViewProps>('RainbowView')
```

ãã—ã¦ `RainbowView` ã«å¯¾ã—ã¦ `updateMillis` ã® props ã‚’æŒ‡å®šã™ã‚Œã°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript:App.tsx
const App = () => <RainbowView
  updateMillis={2000}
  style={styles.rainbow}
/>
```

# 3. ãƒã‚¤ãƒ†ã‚£ãƒ–ã‹ã‚‰ React Native ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¼ãˆã‚‹

ä»Šåº¦ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ã‹ã‚‰ React Native ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¼ãˆãŸã„å ´åˆã§ã™ã€‚ ä¾‹ãˆã°è‰²ãŒå¤‰ã‚ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ¬¡ã®è‰²ã‚’ React Native ã«ä¼ãˆã‚‹ã‚ˆã†ã«ã—ãŸã„å ´åˆã‚’è€ƒãˆã¾ã™ã€‚

Android å´ã§ã¯ `ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²` ã¨ `ã‚¤ãƒ™ãƒ³ãƒˆã®é€ä¿¡` ã®å®Ÿè£…ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ `ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²` ã¯ `ViewManager` ã® `getExportedCustomDirectEventTypeConstants()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¾ã™ã€‚

```kotlin:RainbowViewManager.kt
class RainbowViewManager : SimpleViewManager<RainbowView>() {
    ...

    override fun getExportedCustomDirectEventTypeConstants(): MutableMap<String, Any> {
        return mutableMapOf(
            "onColorChanged" // ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹éš›ã«æŒ‡å®šã™ã‚‹åå‰
                to mutableMapOf(
                  "registrationName" to "onColorChanged") // React Native å´ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‚ç…§ã™ã‚‹éš›ã«ä½¿ã†åå‰
        )
    }
}
```

ä¸Šè¨˜ã®æœ€åˆã®æ–¹ã® `onColorChanged` ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹éš›ã«æŒ‡å®šã™ã‚‹åå‰ã«ãªã‚Šã¾ã™ã€‚ `registrationName` ã¯å›ºå®šã§è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãã®å¾Œã® `onColorChanged` ã¯ React Native å´ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‚ç…§ã™ã‚‹éš›ã®åå‰ã«ãªã‚Šã¾ã™ã€‚
ä¾‹ã§ã¯åŒã˜åå‰ã«ã—ã¦ã„ã¾ã™ãŒã€ã‚‚ã¡ã‚ã‚“ç•°ãªã‚‹åå‰ã‚’è¨­å®šã—ã¦ã‚‚å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

æ¬¡ã« `ã‚¤ãƒ™ãƒ³ãƒˆã®é€ä¿¡` ã§ã™ãŒã€ã“ã‚Œã¯ `RainbowView` ã§è‰²ãŒå¤‰ã‚ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä»¥ä¸‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

```kotlin:RainbowView.kt
class RainbowView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : View(context, attrs, defStyleAttr) {

    ...
  
    private fun sendColorChangedEventToJs(color: Int) {
        val arguments = Arguments.createMap().apply {
            // ã‚«ãƒ©ãƒ¼å€¤ã‚’16é€²æ•°ã®æ–‡å­—åˆ—ã«å¤‰æ›
            putString("color", "0x${color.toUInt().toString(16)}")
        }
        (context as ReactContext)
            .getJSModule(RCTEventEmitter::class.java)
            .receiveEvent(id, "onColorChanged", arguments)
    }
}
```

ä¸Šè¨˜ã®ä¾‹ã®ã‚ˆã†ã« `WritableMap` ã«é€ã‚ŠãŸã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ ã“ã“ã§ã¯ã‚«ãƒ©ãƒ¼å€¤ã‚’16é€²æ•°ã®æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦é€ã£ã¦ã„ã¾ã™ã€‚

React Native å´ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹ãŸã‚ã«ã€`RainbowViewProps` ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¿½åŠ ã—ã¾ã™ã€‚ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®åå‰ã¯å‰è¿°ã®é€šã‚Šã€€`RainbowViewManager` ã® `getExportedCustomDirectEventTypeConstants()` ã§è¨­å®šã—ãŸåå‰ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```typescript:RainbowView.ts
import { NativeSyntheticEvent, requireNativeComponent, ViewProps } from 'react-native'

type ColorChangedData = {
  color: string
}

type RainbowViewProps = Readonly<{
  updateMillis?: number
  onColorChanged?: (e: NativeSyntheticEvent<ColorChangedData>) => void
} & ViewProps>

export const RainbowView =
  requireNativeComponent<RainbowViewProps>('RainbowView')
```

è¿½åŠ ã—ãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript:App.tsx
const App = () => <RainbowView
  style={styles.rainbow}
  onColorChanged={e => console.log('color changed: ', e.nativeEvent.color)}
/>
```

# 4. React Native ã‹ã‚‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¼ãˆã‚‹

æœ€å¾Œã« React Native ã‹ã‚‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¼ãˆãŸã„å ´åˆã§ã™ã€‚ `RainbowView` ã§ã¯è‡ªå‹•ã§ä¸€å®šæ™‚é–“ã”ã¨ã«è‰²ãŒå¤‰ã‚ã‚Šã¾ã™ãŒã€è‰²ãŒå¤‰ã‚ã‚‹ã®ã‚’é–‹å§‹ã€çµ‚äº†ã§ãã‚‹ã‚ˆã†ã«åˆ¶å¾¡ã—ãŸã„å ´åˆã‚’è€ƒãˆã¾ã™ã€‚

Android å´ã§ã¯ `ViewManager` ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã§ `getCommandsMap()` ã¨ `receiveCommand()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ `RainbowViewManager` ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```kotlin:RainbowViewManager.kt
class RainbowViewManager : SimpleViewManager<RainbowView>() {
    ...
  
    override fun getCommandsMap(): Map<String, Int> {
        // ã‚¤ãƒ™ãƒ³ãƒˆåã¨æ•°å€¤ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹
        return mapOf("start" to COMMAND_START, "stop" to COMMAND_STOP)
    }

    override fun receiveCommand(view: RainbowView, commandId: String, args: ReadableArray?) {
        super.receiveCommand(view, commandId, args)

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã£ãŸéš›ã®å‡¦ç†ã‚’ã“ã“ã«æ›¸ã.
        when (commandId.toInt()) {
            COMMAND_START -> {
                view.startChangeColor()
            }
            COMMAND_STOP -> {
                view.stopChangeColor()
            }
        }
    }

    companion object {
        private const val COMMAND_START = 1
        private const val COMMAND_STOP = 2
    }
}
```

`getCommandsMap()` ã§ã¯ã‚¤ãƒ™ãƒ³ãƒˆåã¨æ•°å€¤ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚ ã“ã“ã§ã¯ `start` ã¨ `stop` ã¨ã„ã†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ React Native ã‹ã‚‰å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

æ¬¡ã« `receiveCommand()` ã§ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã£ãŸéš›ã®å‡¦ç†ã‚’è¨˜è¿°ã—ã¾ã™ã€‚ React Native ã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚é€ã‚‹ã“ã¨ãŒã§ãã€é€ã£ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ `args` ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚


ç¶šã„ã¦ React Native å´ã§ã™ã€‚ ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã—ã¾ã™ã€‚

```typescript:RainbowView.ts
import { NativeSyntheticEvent, requireNativeComponent, UIManager, ViewProps } from 'react-native'

...

export const start = (viewId) =>
  UIManager.dispatchViewManagerCommand(
    viewId,
    UIManager.RainbowView.Commands.start.toString(),
    [] // ãƒã‚¤ãƒ†ã‚£ãƒ–ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã—ãŸã„å ´åˆã¯ã“ã®é…åˆ—ã«å€¤ã‚’è¨­å®šã™ã‚‹
  )

export const stop = (viewId) =>
  UIManager.dispatchViewManagerCommand(
    viewId,
    UIManager.RainbowView.Commands.stop.toString(),
    []
  )
```

ä¸Šè¨˜ã® `UIManager.dispatchViewManagerCommand()` ã®ç¬¬äºŒå¼•æ•°ã«ã¯ã€`RainbowViewManager` ã® `getCommandsMap()` ã§è¨­å®šã—ãŸ `start` ã¨ `stop` ã®ã‚¤ãƒ™ãƒ³ãƒˆåãŒãã‚Œãã‚Œä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚

ã‚ã¨ã¯ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¾ã™ã€‚


```typescript:App.tsx
const App = () => {
  const [started, setStarted] = useState(false)
  const rainbowViewRef = useRef(null)

  return (
    <View>
      <Button
        ...
        title={started ? 'stop' : 'start'}
        onPress={() => {
          const viewId = findNodeHandle(rainbowViewRef.current)
          if (started) {
            stop(viewId)
            setStarted(false)
          } else {
            start(viewId)
            setStarted(true)
          }
        }}
      />
      <RainbowView
        ref={rainbowViewRef}
        ...
      />
    </View>
  )
}
```

`viewId` ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã§ä½œæˆã—ãŸãƒ“ãƒ¥ãƒ¼ï¼ˆã“ã“ã§ã¯ `RainbowView`ï¼‰ã«å¯¾ã—ã¦ `ref` ã‚’è¨­å®šã—ã¾ã™ã€‚ ãã—ã¦ `findNodeHandle()` ã« `ref.current` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ `viewId` ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãã—ã¦å…ˆã»ã©å®šç¾©ã—ãŸ `start` ã‚‚ã—ãã¯ `stop` é–¢æ•°ã«ã€`viewId` ã‚’æ¸¡ã—ã¦å‘¼ã³å‡ºã™ã“ã¨ã§ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã«å¯¾ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¼ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

# ãã®ä»– Tips

## onDropViewInstance() ãƒ¡ã‚½ãƒƒãƒ‰

`ViewManager` ã«ã¯ `onDropViewInstance()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ View ã®å¾Œå‡¦ç†ã‚’ã—ãŸã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚

ãƒã‚¤ãƒ†ã‚£ãƒ–ã§è¡¨ç¤ºã—ãŸãƒ“ãƒ¥ãƒ¼ãŒä½¿ã‚ã‚Œãªããªã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€ãƒ“ãƒ¥ãƒ¼ã®å¾Œå‡¦ç†ãŒå¿…è¦ãªå ´åˆã«ã¯ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã«å‡¦ç†ã‚’æ›¸ãã¨ã‚ˆã„ã§ã™ã€‚

```kotlin:RainbowViewManager.kt
class RainbowViewManager : SimpleViewManager<RainbowView>() {

    override fun onDropViewInstance(view: RainbowView) {
        // ãƒ“ãƒ¥ãƒ¼ã®å¾Œå‡¦ç†ã‚’ã“ã“ã«è¨˜è¿°ã™ã‚‹...
        super.onDropViewInstance(view)
    }
    
    ...
}
```

## onAfterUpdateTransaction() ãƒ¡ã‚½ãƒƒãƒ‰

å‰è¿°ã® `@ReactProp` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ãŸã‚»ãƒƒã‚¿ãƒ¼ã¯ `ViewManager` å†…ã«è¤‡æ•°å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ ä¾‹ãˆã°è¤‡æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ãŸå¾Œã«ä½•ã‹å‡¦ç†ã—ãŸã„å ´åˆã«ã¯ `ViewManager` ã® `onAfterUpdateTransaction()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒä½¿ãˆã¾ã™ã€‚

`@ReactProp` ã‚’ä½¿ã£ã¦ãƒã‚¤ãƒ†ã‚£ãƒ–ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ¸¡ã™å ´åˆã€`onAfterUpdateTransaction()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯å…¨ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ¸¡ã•ã‚ŒãŸå¾Œã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«å…¨ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ã¦ã‹ã‚‰åˆæœŸåŒ–å‡¦ç†ãªã©ã‚’è¡Œã„ãŸã„ã€ã¨ã„ã†ã‚ˆã†ãªå ´åˆã«ä¾¿åˆ©ã§ã™ã€‚

```kotlin:RainbowView.kt
class RainbowView ... {
    var intValue: Int = 0
    var stringValue: String = ""
    private var isInitialized: Boolean = false
  
    fun initialize() {
        if (isInitialized) {
            return
        }
        isInitialized = true
      
        // intValue, stringValue ã‚’ä½¿ã£ãŸåˆæœŸåŒ–å‡¦ç†ã‚’ã“ã“ã«è¨˜è¿°ã™ã‚‹...
    }
}
```

```kotlin:RainbowViewManager.kt
class RainbowViewManager : SimpleViewManager<RainbowView>() {

    @ReactProp(name = "intValue")
    fun setIntValue(view: RainbowView, intValue: Int) {
        view.intValue = intValue
    }

    @ReactProp(name = "stringValue")
    fun setStringValue(view: RainbowView, stringValue: String) {
        view.stringValue = stringValue
    }

    override fun onAfterUpdateTransaction(view: RainbowView) {
        // æ›´æ–°ãŒã‚ã£ãŸå…¨ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã® @ReactProp ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚ŒãŸå¾Œã«ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã‚‹
        super.onAfterUpdateTransaction(view)
        view.initialize()
    }

```

## getExportedViewConstants()

ãƒã‚¤ãƒ†ã‚£ãƒ–ã§å®šç¾©ã—ãŸå®šæ•°ã‚’ React Native ã§ä½¿ã†ãŸã‚ã«ã€€`ViewManager` ã® `getExportedViewConstants()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒä½¿ãˆã¾ã™ã€‚ ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ React Native ã§å‚ç…§ã™ã‚‹éš›ã®åå‰ã¨å®šæ•°å€¤ã‚’ Map ã¨ã—ã¦è¿”ã™ã“ã¨ã§ã€React Native ã§ã“ã®å®šæ•°å€¤ãŒå‚ç…§ã§ãã¾ã™ã€‚

```kotlin:RainbowViewManager.kt
class RainbowViewManager : SimpleViewManager<RainbowView>() {
    ...
  
    override fun getExportedViewConstants(): Map<String, Any> {
        return mapOf("DEFAULT_INT_VALUE" to 1, "DEFAULT_STRING_VALUE" to "hoge")
    }
}
```

```typescript
// ãƒã‚¤ãƒ†ã‚£ãƒ–ã§å®šç¾©ã—ãŸå®šæ•°ã¯ UIManager.<ViewName>.Constants.<å®šæ•°å€¤å> ã§å‚ç…§ã§ãã‚‹
export const DEFAULT_INT_VALUE =
  UIManager.RainbowView.Constants.DEFAULT_INT_VALUE

export const DEFAULT_STRING_VALUE =
  UIManager.RainbowView.Constants.DEFAULT_STRING_VALUE
```

# å‚è€ƒ

- https://reactnative.dev/docs/native-components-android
- https://github.com/facebook/react-native/blob/main/ReactAndroid/src/main/java/com/facebook/react/uimanager/ViewManager.java