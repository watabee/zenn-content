---
title: "2024å¹´ä»¥é™ã§ã‚‚ Android ã§ WebView ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ã‚ãªãŸã¸"
emoji: "ğŸŒ"
type: "tech"
topics:
  - "android"
  - "gradle"
  - "javascript"
  - "typescript"
  - "webview"
published: true
published_at: "2023-12-01 07:00"
publication_name: "aldagram_tech"
---

ã“ã‚“ã«ã¡ã¯ï¼ã‚¢ãƒ«ãƒ€ã‚°ãƒ©ãƒ ã§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ã‚‹æ¸¡é‚Šã§ã™ï¼
æœ¬è¨˜äº‹ã¯[æ ªå¼ä¼šç¤¾ã‚¢ãƒ«ãƒ€ã‚°ãƒ©ãƒ  Advent Calendar 2023](https://qiita.com/advent-calendar/2023/aldagram) 1æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

æ—©ã„ã‚‚ã®ã§2023å¹´ã‚‚ã‚ã¨ä¸€ãƒ¶æœˆã¨ãªã‚Šã€2024å¹´ã‚‚ã¾ã‚‚ãªãã§ã™ã€‚æœ€è¿‘ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã®ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é–‹ç™ºã§ã¯ Flutter ã‚„ Kotlin Multiplatform ãªã©ã‚’ã‚ˆãè¦‹ã‹ã‘ã¾ã™ã€‚

ã—ã‹ã—ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é–‹ç™ºã¨ã„ãˆã°... ãã† **WebView** ã‚’ä½¿ã£ãŸæ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ ã“ã‚Œã¯ WebView ã§ HTML ã‚’è¡¨ç¤ºã•ã›ã‚‹ã“ã¨ã§ Android ã‚„ iOS ãªã©ã§å…±é€šã«ç”»é¢ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã§ã€ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªé–‹ç™ºã®åˆæœŸã‹ã‚‰ã‚ã£ãŸæ–¹æ³•ã§ã™ã€‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹æˆã‚„å·¥æ•°ã€å®Ÿè£…é›£æ˜“åº¦ã«ã‚ˆã£ã¦ WebView ã‚’ä½¿ã£ãŸé–‹ç™ºã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒã€å€‹äººçš„ãªæ„è¦‹ã¨ã—ã¦ãã‚Œã¯é¸æŠè‚¢ã¨ã—ã¦ã‚¢ãƒªã‹ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

æœ€è¿‘ã‚¢ãƒ—ãƒªãƒãƒ¼ãƒ ã§ã‚‚ WebView ã‚’ä½¿ã£ãŸé–‹ç™ºã‚’è¡Œã„ã¾ã—ãŸã®ã§ã€ä»Šå›ã¯ãã®æ™‚ã«å¾—ãŸçŸ¥è¦‹ã‚’å…±æœ‰ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
å†…å®¹ã¨ã—ã¦ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚

- WebView ã®ãƒ‡ãƒãƒƒã‚°
- WebViewAssetLoader ã§ Android ã‚¢ãƒ—ãƒªã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ HTML ã§å‚ç…§ã™ã‚‹
- Android <-> JavaScript ã®é€£æº
- TypeScript ã‚’ä½¿ç”¨ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè£…

[ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å…¬é–‹](https://github.com/watabee/AndroidWebViewDemo)ã—ã¦ã„ã¾ã™ã®ã§ã€ã“ã¡ã‚‰ã‚‚å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

# WebView ã®ãƒ‡ãƒãƒƒã‚°

Chrome ã® DevTools ã‚’ä½¿ã£ã¦ WebView ã®ãƒ‡ãƒãƒƒã‚°ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ ãã®ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```kotlin
WebView.setWebContentsDebuggingEnabled(true)
```

æ³¨æ„ç‚¹ã¨ã—ã¦ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹è¨­å®šã®ãŸã‚ã€**ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹ã‚¢ãƒ—ãƒªã§ã¯å‘¼ã³å‡ºã•ãªã„ã‚ˆã†ã«ã™ã‚‹**è¨­å®šãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ ãã®ãŸã‚ã€ä¾‹ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã« debuggable ãƒ•ãƒ©ã‚°ãŒæœ‰åŠ¹ã®å ´åˆã ã‘å‘¼ã³å‡ºã™ãªã©ã€ãƒªãƒªãƒ¼ã‚¹ã‚¢ãƒ—ãƒªã§ã¯å‘¼ã³å‡ºã•ã‚Œãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

```kotlin
if (applicationInfo.flags and ApplicationInfo.FLAG_DEBUGGABLE != 0) {
    WebView.setWebContentsDebuggingEnabled(true)
}
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ãŒè¨­å®šã§ããŸã‚‰ Chrome ã® DevTools ã‚’èµ·å‹•ã—ã¾ã™ã€‚ ãã®ãŸã‚ã«ã¯ä»¥ä¸‹ã®æ‰‹é †ãŒå¿…è¦ã§ã™ã€‚

1. ç«¯æœ«ã§ã€Œé–‹ç™ºè€…å‘ã‘ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã®ç”»é¢ã‚’é–‹ã
    - é–‹ç™ºè€…å‘ã‘ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯[ã“ã¡ã‚‰](https://developer.android.com/studio/debug/dev-options.html)ã‚’å‚è€ƒ
2. ã€ŒUSB ãƒ‡ãƒãƒƒã‚°ã€ã‚’æœ‰åŠ¹ã«ã™ã‚‹
3. PC ã§ Chrome ã‚’é–‹ã
4. `chrome://inspect#devices` ã‚’é–‹ã
5. ã€ŒDiscover USB devicesã€ã‚’æœ‰åŠ¹ã«ã™ã‚‹
6. USB ã‚±ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ã£ã¦ Android ç«¯æœ«ã¨ PC ã‚’ç¹‹ã
7. ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ WebView ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ç”»é¢ã‚’é–‹ã

ä¸Šè¨˜æ‰‹é †ã‚’å®Ÿè¡Œã—ã€ä»¥ä¸‹ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ã®èµ¤æ ã®ã‚ˆã†ã«ç«¯æœ«ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æº–å‚™ã¯å®Œäº†ã§ã™ã€‚ èµ¤æ å†…ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ `insepct` ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

| ![](https://storage.googleapis.com/zenn-user-upload/7691abe07158-20231128.png) |
| --- |

ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ ã“ã®ç”»é¢ã‚’ä½¿ã£ã¦ HTML ã®è¡¨ç¤ºã®ç¢ºèªã‚„å¤‰æ›´ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ç¢ºèªã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ã®å†…å®¹ã‚’è¦‹ã‚‹ã¨ã„ã£ãŸæ§˜ã€…ãªã“ã¨ãŒã§ãã¾ã™ã€‚

| ![](https://storage.googleapis.com/zenn-user-upload/a77b829975ac-20231128.png) |
| --- |

é–‹ç™ºã™ã‚‹éš›ã«ã¯éå¸¸ã«ä¾¿åˆ©ã§ã™ã®ã§ã€WebView ã®ãƒ‡ãƒãƒƒã‚°ãŒã§ãã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ãŠãã“ã¨ã‚’ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™ã€‚

# WebViewAssetLoader ã§ Android ã‚¢ãƒ—ãƒªã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ HTML ã§å‚ç…§ã™ã‚‹

[WebViewAssetLoader](https://developer.android.com/reference/androidx/webkit/WebViewAssetLoader) ã‚’ä½¿ã†ã“ã¨ã§ã€Android ã®ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- assets ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒªã‚½ãƒ¼ã‚¹
- res ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒªã‚½ãƒ¼ã‚¹
- å†…éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å†…ã®ãƒªã‚½ãƒ¼ã‚¹

ã¾ãŸãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã«ã€`file://` ã®å½¢å¼ã§ã¯ãªã Web ã®ã‚ˆã†ãª URL å½¢å¼ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

WebViewAssetLoader ã‚’ä½¿ã†ã«ã¯ [androidx.webkit](https://developer.android.com/jetpack/androidx/releases/webkit) ãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€ä¾å­˜é–¢ä¿‚ã‚’è¨­å®šã—ã¾ã™ã€‚

```kotlin:app/build.gradle.kts
dependencies {
    implementation("androidx.webkit:webkit:1.8.0")
}
```

ã¾ãšã¯ WebViewAssetLoader ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```kotlin
val cacheImagesFile = File(context.cacheDir, "images").apply { mkdirs() }
val assetLoader = WebViewAssetLoader.Builder()
    .addPathHandler("/assets/", WebViewAssetLoader.AssetsPathHandler(context))
    .addPathHandler("/res/", WebViewAssetLoader.ResourcesPathHandler(context))
    .addPathHandler("/cache_images/", WebViewAssetLoader.InternalStoragePathHandler(context, cacheImagesFile))
    .build()
```

addPathHandler ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¬¬ä¸€å¼•æ•°ã«ã¯ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¾ã™ã€‚ ç¬¬äºŒå¼•æ•°ã«ã¯ `PathHandler` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¨­å®šã—ã¾ã™ã€‚ ã“ã‚Œã¯æŒ‡å®šã—ãŸãƒ‘ã‚¹ã«å¯¾ã—ã¦ã©ã“ã‹ã‚‰ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹ã‹ã‚’è¡¨ã—ã¾ã™ã€‚ WebViewAssetLoader ã§ã¯ assets ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰å–å¾—ã™ã‚‹ `AssetsPathHandler`ã€res ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰å–å¾—ã™ã‚‹ `ResourcesPathHandler`ã€å†…éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã™ã‚‹ `InternalStoragePathHandler` ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã¾ãŸ WebViewAssetLoader ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `appassets.androidplatform.net` ã¨ã„ã†ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ ã§ã™ã®ã§ä¾‹ãˆã° res/drawable ãƒ•ã‚©ãƒ«ãƒ€å†…ã«ã‚ã‚‹ image.png ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã¯ `https://appassets.androidplatform.net/res/drawable/image.png` ã¨ã„ã†ãƒ‘ã‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

:::message
`appassets.androidplatform.net` ã¯ WebViewAssetLoader ã® `DEFAULT_DOMAIN` ã¨ã„ã†å¤‰æ•°ã«å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
:::

ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« `setDomain` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ ã§ã™ã®ã§ HTML ãŒ Web ä¸Šã«ã‚ã‚‹å ´åˆã¯å¯¾è±¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã™ã‚‹ã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

```kotlin
val assetLoader = WebViewAssetLoader.Builder()
    .setDomein("raw.githubusercontent.com")
    ...
```

WebViewAssetLoader ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ãŸã‚‰ `WebViewClient` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€`shouldInterceptRequest` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¾ã™ã€‚ ãã®ãƒ¡ã‚½ãƒƒãƒ‰ä¸­ã§ `WebViewAssetLoader#shouldInterceptRequest` ã‚’å‘¼ã³å‡ºã—ã¦è¨­å®šã¯å®Œäº†ã§ã™ã€‚

```kotlin
webView.webViewClient = object: WebViewClientCompat() {
    override fun shouldInterceptRequest(view: WebView?, request: WebResourceRequest): WebResourceResponse? {
        return assetLoader.shouldInterceptRequest(request.url)
    }
}
```

ä¾‹ãˆã° assets ãƒ•ã‚©ãƒ«ãƒ€ã« `sample.html` ãŒã‚ã£ãŸå ´åˆã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã« HTML ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```kotlin
webView.loadUrl("https://appassets.androidplatform.net/assets/sample.html")
```

ã¾ãŸã€ä¾‹ãˆã° HTML å´ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã§ assets ãƒ•ã‚©ãƒ«ãƒ€å†…ã® bundle.js ã‚’èª­ã¿è¾¼ã‚“ã ã‚Šã€res/drawable ãƒ•ã‚©ãƒ«ãƒ€å†…ã® image.png ã‚’èª­ã¿è¾¼ã‚“ã ã‚Šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Android WebView Demo</title>
    <script src="https://appassets.androidplatform.net/assets/bundle.js"></script>
</head>
<body>
    <img src="https://appassets.androidplatform.net/res/drawable/image.png" />
</body>
</html>
```

# Android <-> JavaScript ã®é€£æº

Android <-> JavaScript ã®é€£æºã§ã¯ã€ä»¥ä¸‹ã®2ã¤ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

1. Android ã‹ã‚‰ JavaScript ã‚’å®Ÿè¡Œã™ã‚‹
2. JavaScript ã‹ã‚‰ Android ã¸æ–‡å­—åˆ—ã‚’é€ã‚‹

æ³¨æ„ç‚¹ã¨ã—ã¦ã€JavaScript é€£æºã™ã‚‹ãŸã‚ã«ã¯ JavaScript ã‚’æœ‰åŠ¹ã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```kotlin
webView.settings.javaScriptEnabled = true
```

## Android ã‹ã‚‰ JavaScript ã‚’å®Ÿè¡Œã™ã‚‹

Android ã‹ã‚‰ JavaScript ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€[WebView#evaluateJavaScript](https://developer.android.com/reference/android/webkit/WebView#evaluateJavascript(java.lang.String,%20android.webkit.ValueCallback%3Cjava.lang.String%3E)) ã‚’ä½¿ã„ã¾ã™ã€‚

ä¾‹ãˆã°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’è¡¨ç¤ºã•ã›ãŸã„å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```kotlin
webView.evaluateJavaScript("console.log('Hello, JavaScript!')", null)
```

## JavaScript ã‹ã‚‰ Android ã¸æ–‡å­—åˆ—ã‚’é€ã‚‹

JavaScript ã‹ã‚‰ã¯ Android ã«æ–‡å­—åˆ—ã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ ã“ã‚Œã¯ [android/view-widgets-samples ã®ãƒªãƒã‚¸ãƒˆãƒªã« WebView ã‚’ä½¿ã£ãŸã‚µãƒ³ãƒ—ãƒ«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹](https://github.com/android/views-widgets-samples/tree/main/WebView) ã®ã§ã€ã“ã¡ã‚‰ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® [JsObject](https://github.com/android/views-widgets-samples/blob/main/WebView/app/src/main/java/com/android/samples/webviewdemo/JsObject.kt) ãƒ•ã‚¡ã‚¤ãƒ«ã« `createJsObject` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚


:::details JsObject.kt
```kotlin:JsObject.kt
fun createJsObject(
    webview: WebView,
    jsObjName: String,
    allowedOriginRules: Set<String>,
    onMessageReceived: (message: String) -> Unit
) {
    if (WebViewFeature.isFeatureSupported(WebViewFeature.WEB_MESSAGE_LISTENER)) {
        WebViewCompat.addWebMessageListener(
            webview, jsObjName, allowedOriginRules
        ) { _, message, _, _, _ -> onMessageReceived(message.data!!) }
    } else {
        webview.addJavascriptInterface(object {
            @JavascriptInterface
            fun postMessage(message: String) {
                // Use the handler to invoke method on UI thread
                handler.post { onMessageReceived(message) }
            }
        }, jsObjName)
    }
}
```
:::

ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ JavaScript ã‹ã‚‰ Android ã«æ–‡å­—åˆ—ã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ ã¾ãš Android å´ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«é€ã‚‰ã‚Œã¦ããŸæ–‡å­—åˆ—ã‚’å—ã‘å–ã‚‹æº–å‚™ã‚’ã—ã¾ã™ã€‚

```kotlin
val webView: WebView = findViewById(R.id.web_view)
createJsObject(
    webView, 
    jsObjName = "jsObject", 
    allowedOriginRules = setOf("https://appassets.androidplatform.net")
) { message ->
    // JavaScript ã‹ã‚‰æ–‡å­—åˆ—ãŒé€ã‚‰ã‚Œã¦ããŸæ™‚ã®å‡¦ç†ã‚’ã“ã“ã«æ›¸ã...
}
webView.loadUrl("https://appassets.androidplatform.net/assets/sample.html")
```

`jsObjName` ã«ã¯ JavaScript å´ã§ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™éš›ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåã‚’æŒ‡å®šã—ã¾ã™ã€‚ `allowedOriginRules` ã¯è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã®ä¸€è¦§ã‚’æŒ‡å®šã—ã¾ã™ã€‚ æœ€å¾Œã®å¼•æ•°ã«ã¯ãƒ©ãƒ ãƒ€ã‚’æŒ‡å®šã—ã¾ã™ã€‚ ã“ã®ãƒ©ãƒ ãƒ€ã¯ JavaScript ã‹ã‚‰æ–‡å­—åˆ—ãŒé€ã‚‰ã‚Œã¦ããŸéš›ã«å‘¼ã°ã‚Œã¾ã™ã€‚

ç¶šã„ã¦ JavaScript å´ã§ã™ã€‚ å‘¼ã³å‡ºã™æ™‚ã« `jsObjName` ã§æŒ‡å®šã—ãŸå¤‰æ•°åã‚’ä½¿ã£ã¦ `postMessage()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```javascript
jsObject.postMessage('Hello, Android!')
```

ã“ã‚Œã§ JavaScript ã‹ã‚‰ Android ã«æ–‡å­—åˆ—ã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚‚ã— JavaScript ã‹ã‚‰è‰²ã€…ãªãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€æ–‡å­—åˆ—ã ã‘ã®ã‚„ã‚Šå–ã‚Šã ã¨è¾›ã„å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€JSON æ–‡å­—åˆ—ã‚’é€ã£ã¦ Android å´ã§ã¯ãã‚Œã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ä½¿ã†ã¨ã„ã£ãŸæ–¹æ³•ã‚‚æœ‰åŠ¹ã‹ã¨æ€ã„ã¾ã™ã€‚

```javascript
jsObject.postMessage(JSON.stringify({ data1: ..., data2: ... }))
```

:::message
androidx.webkit ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã€build.gradle ã«ä¾å­˜é–¢ä¿‚ã‚’å«ã‚ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```kotlin:app/build.gradle.kts
dependencies {
    implementation("androidx.webkit:webkit:1.8.0")
}
```
:::

# TypeScript ã‚’ä½¿ç”¨ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè£…

WebView ã§ã®é–‹ç™ºã«ãŠã„ã¦ JavaScript ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯å¤§ã„ã«è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ ã—ã‹ã—ä»¤å’Œã‚‚6å¹´ã«ãªã‚ã†ã¨ã—ã¦ã„ã‚‹æ™‚ä»£ã«ç´ ã® JavaScript ã‚’æ›¸ãã®ã¯ãƒ„ãƒ©ã„ã¨ã„ã†æ–¹ã¯å¤šã„ã®ã§ã¯ãªã„ã®ã§ã—ã‚‡ã†ã‹ã€‚ ã“ã“ã§ã¯ TypeScript ã‚’ä½¿ã£ã¦é–‹ç™ºã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

å¤§ã¾ã‹ãªæµã‚Œã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

1. TypeScript ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè£…
2. TypeScript ã‚’ JavaScript ã«å¤‰æ›ï¼ˆãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ï¼‰ã—ã€ä¸€ã¤ã® JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹ï¼ˆãƒãƒ³ãƒ‰ãƒ«ï¼‰
3. JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ assets ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã™ã‚‹

2ã¨3ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã«ã‚ãŸã‚Šã€ã‚«ã‚¹ã‚¿ãƒ ã® Gradle ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½œæˆã—ã¦ Android ã‚¢ãƒ—ãƒªã®ãƒ“ãƒ«ãƒ‰æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ ãã†ã™ã‚‹ã“ã¨ã§ã€ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¢ãƒ—ãƒªã§ JavaScript ãŒæ›´æ–°ã•ã‚Œã¦ã„ãªã„ã€ãªã©ã®ãƒŸã‚¹ãŒé˜²ã’ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚
ãã‚Œã§ã¯é †ç•ªã«èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

## TypeScript ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ãšã¯ TypeScript é–¢é€£ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€ãã®ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¾ã™ã€‚

```shell
$ mkdir app/typescript && cd app/typescript
```

ç§»å‹•ã—ãŸã‚‰ npm ã§ TypeScript ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ï¼ˆNode.js ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æã§ã™ï¼‰

```shell
$ npm init -y && npm install -D typescript
```

ç¶šã„ã¦ `tsconfig.json` ã‚’ä½œæˆã—ã¾ã™ã€‚ å†…å®¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

```json:tsconfig.json
{  
  "compilerOptions": {  
    "target": "ES5",  
    "module": "ES2015",  
    "strict": true
  },  
  "include": ["src/**/*.ts"],  
  "exclude": ["node_modules"]  
}
```

TypeScript ã®ã‚³ãƒ¼ãƒ‰ã¯ `src` ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã™ã‚‹ãŸã‚ã€`src` ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚

```shell
$ mkdir src
```

## rollup ã®è¨­å®š

TypeScript ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œã•ã›ã‚‹ãŸã‚ã«ã¯ JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›ã™ã‚‹ï¼ˆãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã¨ã„ã†ï¼‰å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ã¾ãŸè¤‡æ•°ã® JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã£ãŸå ´åˆã€ä¸€ã¤ã® JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ãŸæ–¹ãŒãƒ–ãƒ©ã‚¦ã‚¶ã§èª­ã¿è¾¼ã‚€æ™‚ã«åŠ¹ç‡ãŒã‚ˆã„ã®ã§ã€JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€ã¤ã«ã¾ã¨ã‚ã‚‹ï¼ˆãƒãƒ³ãƒ‰ãƒ«ã¨ã„ã†ï¼‰ã‚ˆã†ã«ã—ã¾ã™ã€‚

JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã®ã“ã¨ã‚’**ãƒãƒ³ãƒ‰ãƒ©ãƒ¼**ã¨è¨€ã„ã¾ã™ãŒã€ã“ã“ã§ã¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä¸€ã¤ã§ã‚ã‚‹ [rollup](https://rollupjs.org/) ã‚’ä½¿ã£ã¦ãƒãƒ³ãƒ‰ãƒ«ã‚’è¡Œã„ã¾ã™ã€‚ rollup ã«ã¯[ãƒ—ãƒ©ã‚°ã‚¤ãƒ³](https://github.com/rollup/plugins) ãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€TypeScript ã‹ã‚‰ JavaScript ã¸ã®å¤‰æ›ã¯ [@rollup/plugin-typescript](https://github.com/rollup/plugins/tree/master/packages/typescript) ã«ã‚ˆã£ã¦è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãŸãƒãƒ³ãƒ‰ãƒ«ã—ãŸ JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¥µåŠ›å°ã•ã„ã‚µã‚¤ã‚ºã«ã™ã‚‹ãŸã‚ã« [@rollup/plugin-terser](https://github.com/rollup/plugins/tree/master/packages/terser) ã¨ã„ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ä½¿ç”¨ã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã‚’ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```shell
$ npm install -D rollup tslib @rollup/plugin-typescript @rollup/plugin-terser
```

ç¶šã„ã¦ `rollup.config.mjs` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

:::details rollup.config.mjs
```javascript:rollup.config.mjs
import terser from '@rollup/plugin-terser';
import typescript from '@rollup/plugin-typescript';
import tsconfig from "./tsconfig.json" assert { type: "json" };

export default {
    input: 'src/index.ts',
    output: {
        name: 'main',
        format: 'umd',
    },
    plugins: [
        typescript({
            ...tsconfig.compilerOptions,
            include: '**/*.{js,ts}'
        }),
        terser({
            keep_fnames: true
        })
    ]
};
```
:::

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ãƒã‚¤ãƒ³ãƒˆã‚’ã„ãã¤ã‹è§£èª¬ã—ã¾ã™ã€‚

```javascript
input: 'src/index.ts',
```

ã¾ãšã¯ `input` ã®è¨­å®šã§ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¾ã™ã€‚ ä¸€ç•ªãƒ«ãƒ¼ãƒˆã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€ã“ã“ã§ã¯ `src/index.ts` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```javascript
output: {
    name: 'main',
    format: 'umd',
},
```

æ¬¡ã« `output` ã®è¨­å®šã§å‡ºåŠ›ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚ `format` ã‚’ `umd` ã«ã™ã‚‹ã“ã¨ã§ JavaScript ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã‚‚å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«å½¢å¼ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚ ã“ã®å½¢å¼ã§ã¯ JavaScript ã®é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹éš›ã« `name.é–¢æ•°å` ã®ã‚ˆã†ãªå½¢å¼ã§å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã€`name` ã¯ãã®éš›ã®åå‰ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚ ä¾‹ãˆã° `doSomething()` ã¨ã„ã†é–¢æ•°ãŒã‚ã£ãŸå ´åˆã€ã“ã®å ´åˆã¯ `main.doSomething()` ã¨ã„ã†å½¢ã§å‘¼ã³å‡ºã™ã“ã¨ã«ãªã‚Šã¾ã™ã€‚


```javascript
terser({
    keep_fnames: true
})
```

ç¶šã„ã¦ `terser` ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®è¨­å®šã§ã™ã€‚ ã“ã¡ã‚‰ã§å‡ºåŠ›ã•ã‚Œã‚‹ JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºãŒå°ã•ããªã‚‹ã‚ˆã†ã«æœ€é©åŒ–ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ æ³¨æ„ç‚¹ã¨ã—ã¦ã€ä½•ã‚‚è¨­å®šã—ãªã„ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é–¢æ•°åãŒå¤‰ã‚ã£ã¦ã—ã¾ã†ãŸã‚ã€é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹éš›ã« TypeScript ã§æ›¸ã„ãŸé–¢æ•°åã§ã¯ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ããªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ ãã®ãŸã‚ `keep_fnames` ã‚’ true ã«ã™ã‚‹ã“ã¨ã§ã€é–¢æ•°åãŒå¤‰ã‚ã‚‰ãªã„ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚

## ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¨­å®š

ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã¨ãƒãƒ³ãƒ‰ãƒ«ã®å®Ÿè¡Œã¯ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¡Œã†ã‚ˆã†ã«ã—ã¾ã™ã€‚ `bundle.sh` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®å†…å®¹ã§ä½œæˆã—ã¦ãŠãã¾ã™ã€‚

```shell:bundle.sh
#!/bin/bash

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <output_directory>"
    exit 1
fi

output_dir=$1

npm ci
npx rollup --file "$output_dir/bundle.js" -c
```

ã“ã“ã¾ã§ã®æ‰‹é †ã‚’è¡Œã†ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã«ãªã£ã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

```
app/typescript
â”œâ”€â”€ bundle.sh
â”œâ”€â”€ node_modules
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ rollup.config.mjs
â”œâ”€â”€ src
â””â”€â”€ tsconfig.json
```

## ã‚«ã‚¹ã‚¿ãƒ ã® Gradle ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä½œæˆ

ç¶šã„ã¦ã‚«ã‚¹ã‚¿ãƒ ã® Gradle ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä½œæˆã§ã™ã€‚ ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ TypeScript ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’ä¸€ã¤ã® JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›ã—ã€ã“ã® JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ assets ãƒ•ã‚©ãƒ«ãƒ€ã«æ ¼ç´ã—ã¾ã™ã€‚

ã“ã“ã§å‚è€ƒã«ãªã‚‹ã®ãŒ GitHub ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ [android/gradle-recipes](https://github.com/android/gradle-recipes) ã¨ã„ã† Gradle ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚
[addGeneratedSourceFolder](https://github.com/android/gradle-recipes/tree/agp-8.8/addGeneratedSourceFolder) ã¨ã„ã†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã¾ã•ã« Gradle ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å´ã§ç”Ÿæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ assets ãƒ•ã‚©ãƒ«ãƒ€ã«æ ¼ç´ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€ã“ã¡ã‚‰ã‚’å‚è€ƒã«å®Ÿè£…ã—ã¾ã™ã€‚

åŸºæœ¬çš„ã«ã¯ä¸Šè¨˜ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® `build-logic` ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãã®ã¾ã¾ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚³ãƒ”ãƒ¼ã—ã€ä¸€éƒ¨å†…å®¹ã‚’å¤‰æ›´ã™ã‚Œã°ã‚ˆã„ã‹ã¨æ€ã„ã¾ã™ã€‚ å¤‰æ›´ãŒå¿…è¦ãªéƒ¨åˆ†ã‚’é †ç•ªã«èª¬æ˜ã—ã¾ã™ã€‚

æœ€åˆã« [build-logic/plugins/build.gradle.kts](https://github.com/android/gradle-recipes/blob/agp-8.8/addGeneratedSourceFolder/build-logic/plugins/build.gradle.kts) ã§ã™ãŒã€ä»¥ä¸‹ã®éƒ¨åˆ†ã‚’å¤‰æ›´ã—ã¦ã¾ã™ã€‚ `id` ã«ã¤ã„ã¦ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦é©å®œè¨­å®šã—ã¦ãã ã•ã„ã€‚ ã“ã“ã§è¨­å®šã—ãŸ `id` ã¯å¾Œã»ã©ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã«å¿…è¦ã«ãªã‚Šã¾ã™ã€‚

```diff
gradlePlugin {
    plugins {
-       create("customPlugin") {
-           id = "android.recipes.custom_plugin"
-           implementationClass = "CustomPlugin"
+       create("bundleJsPlugin") {
+           id = "io.github.watabee.bundle_js_plugin"
+           implementationClass = "BundleJsPlugin"
        }
    }
}
```

ç¶šã„ã¦ [build-logic/plugins/src/main/kotlin/CustomPlugin.kt](https://github.com/android/gradle-recipes/blob/agp-8.8/addGeneratedSourceFolder/build-logic/plugins/src/main/kotlin/CustomPlugin.kt) ã§ã™ãŒã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸¸ã€…ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

:::details BundleJsPlugin.kt
```kotlin:BundleJsPlugin.kt
import com.android.build.api.variant.AndroidComponentsExtension
import com.android.build.gradle.AppPlugin
import org.gradle.api.Plugin
import org.gradle.api.Project
import org.gradle.api.file.DirectoryProperty
import org.gradle.api.file.FileTree
import org.gradle.api.tasks.Exec
import org.gradle.api.tasks.InputFiles
import org.gradle.api.tasks.Internal
import org.gradle.api.tasks.OutputDirectory
import org.gradle.api.tasks.TaskAction
import org.gradle.kotlin.dsl.register
import java.io.File

class BundleJsPlugin : Plugin<Project> {
    override fun apply(project: Project) {

        project.plugins.withType(AppPlugin::class.java) {
            val androidComponents = project.extensions.getByType(AndroidComponentsExtension::class.java)
            androidComponents.onVariants { variant ->
                variant.sources.assets
                    ?.let {
                        val variantName = variant.name.replaceFirstChar { char ->
                            if (char.isLowerCase()) char.titlecase(Locale.US) else it.toString()
                        }
                        val bundleJsTask = project.tasks.register<BundleJsTask>("bundleJs${variantName}") {
                            workingDir = File(project.projectDir, "typescript")
                            typescriptDir.set(workingDir)
                            nodeModulesDir.set(File(workingDir, "node_modules"))
                        }

                        it.addGeneratedSourceDirectory(
                            bundleJsTask,
                            BundleJsTask::outputDirectory
                        )
                    }
            }
        }
    }
}

abstract class BundleJsTask : Exec() {
    @Internal
    val typescriptDir: DirectoryProperty = project.objects.directoryProperty()

    @Internal
    val nodeModulesDir: DirectoryProperty = project.objects.directoryProperty()

    @get:InputFiles
    val inputFiles: FileTree
        get() = typescriptDir.asFileTree.matching {
            it.exclude("${nodeModulesDir.get().asFile.name}/**")
        }

    @get:OutputDirectory
    abstract val outputDirectory: DirectoryProperty

    @TaskAction
    override fun exec() {
        val outputDir = outputDirectory.get().asFile
        outputDir.mkdirs()

        commandLine = listOf("sh", "bundle.sh", "$outputDir")
        super.exec()
    }
}
```
:::

ä¸Šè¨˜ã®å‡¦ç†ã®å†…å®¹ã¯å…ˆã»ã©ä½œæˆã—ãŸã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã® `bundle.sh` ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ãªã‚Šã¾ã™ã€‚ ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã€ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‹ã©ã†ã‹ã¯å…¥åŠ›å†…å®¹ã«å¤‰æ›´ãŒã‚ã£ãŸã‹ã©ã†ã‹ã§å¤‰ã‚ã‚Šã¾ã™ã€‚

```kotlin
    @get:InputFiles
    val inputFiles: FileTree
        // typescript ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®å¯¾è±¡ã¨ã™ã‚‹
        // ãŸã ã— node_modules ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯é™¤å¤–
        get() = typescriptDir.asFileTree.matching {
            it.exclude("${nodeModulesDir.get().asFile.name}/**")
        }
```

ä¸Šè¨˜ã®è¨­å®šã§ã¯ `typescript` ãƒ•ã‚©ãƒ«ãƒ€å†…ã§ã‹ã¤ `node_modules` ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã«å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ ãã®ãŸã‚å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒãªã‹ã£ãŸå ´åˆã¯å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œãªã„ãŸã‚ã€ãƒ“ãƒ«ãƒ‰æ™‚é–“ã®ç¯€ç´„ã«ãªã‚Šã¾ã™ã€‚

ç¶šã„ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹ `settings.gradle.kts` ã«ä»¥ä¸‹ã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff
pluginManagement {
+   includeBuild("build-logic")
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
```

ä½œã£ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ `app/build.gradle.kts` ã«ä»¥ä¸‹ã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff:app/build.gradle.kts
plugins {
    ...
+   id("io.github.watabee.bundle_js_plugin")
}
```

ã“ã‚Œã§æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸï¼ æœ€å¾Œã« `app/typescript/src/index.ts` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ ä»®ã«ä»¥ä¸‹ã®ã‚ˆã†ã«é©å½“ãªé–¢æ•°ã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚

```typescript:app/typescript/src/index.ts
export function log(message: string) {
    return console.log(message)
}
```

ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡ŒãŒå®Œäº†ã™ã‚‹ã¨ `app/build/generated/assets/bundleJsDebug` ãƒ•ã‚©ãƒ«ãƒ€å†…ã« `bundle.js` ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚ ã“ã‚Œã«ã‚ˆã£ã¦ assets ãƒ•ã‚©ãƒ«ãƒ€å†…ã« `bundle.js` ã‚’æ ¼ç´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸï¼
ã¾ãŸå€‹åˆ¥ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã ã‘ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```shell
$ ./gradlew bundleJsDebug # Debug ã®éƒ¨åˆ†ã¯ Build Variant ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹
```

ã“ã‚Œã«ã‚ˆã£ã¦ Android å´ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« JavaScript ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚ï¼ˆHTML ã§ `bundle.js` ãŒ script ã‚¿ã‚°ã§ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰

```kotlin
webView.evaluateJavaScript("main.log('Hello, WebView!')")
```

# æœ€å¾Œã«

ä»¥ä¸Šã€WebView ã§ã®ã‚¢ãƒ—ãƒªé–‹ç™ºã§å¾—ãŸçŸ¥è¦‹ã‚’å…±æœ‰ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚ å†’é ­ã§ã‚‚ç´¹ä»‹ã—ã¾ã—ãŸãŒ[ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å…¬é–‹](https://github.com/watabee/AndroidWebViewDemo)ã—ã¦ã„ã¾ã™ã€‚ ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ HTML ã®ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã‚‹ã¨ã€Android å´ã§ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã€æ’®å½±ã—ãŸç”»åƒã‚’ HTML ã§è¡¨ç¤ºã™ã‚‹ã€ã¨ã„ã£ãŸã‚¢ãƒ—ãƒªã«ãªã£ã¦ã„ã¾ã™ã®ã§ã€ã“ã¡ã‚‰ã‚‚ãœã²å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c634f0e75e45-20231128.gif =300x)

# å‚è€ƒ

- [Remote debug Android devices](https://developer.chrome.com/docs/devtools/remote-debugging/)
- [Web-based content](https://developer.android.com/develop/ui/views/layout/webapps)
- [Load local content](https://developer.android.com/develop/ui/views/layout/webapps/load-local-content)
- [android/gradle-recipes](https://github.com/android/gradle-recipes)
- [android/views-widgets-samples/WebView](https://github.com/android/views-widgets-samples/tree/main/WebView)


ã‚‚ã£ã¨ã‚¢ãƒ«ãƒ€ã‚°ãƒ©ãƒ ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢çµ„ç¹”ã‚’çŸ¥ã‚ŠãŸã„äººã€ãœã²ä¸‹è¨˜ã®æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¦ãã ã•ã„ï¼

