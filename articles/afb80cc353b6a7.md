---
title: "ã€React Nativeã€‘React Native ã§ Jetpack Compose ã‚’ä½¿ã£ã¦ã¿ã‚‹"
emoji: "ğŸŒŠ"
type: "tech"
topics:
  - "android"
  - "reactnative"
  - "jetpackcompose"
published: true
published_at: "2023-03-14 13:50"
publication_name: "aldagram_tech"
---

ã“ã‚“ã«ã¡ã¯ï¼ã‚¢ãƒ«ãƒ€ã‚°ãƒ©ãƒ ã§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ã‚‹æ¸¡é‚Šã§ã™ï¼

å…ˆæ—¥ [React Native ã® Native UI Components ã§ Android ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹](https://zenn.dev/aldagram_tech/articles/76f49e46e37cc1) ã¨ã„ã†è¨˜äº‹ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸãŒã€ä»Šå›ã¯ãã®å¿œç”¨ã¨ã—ã¦ Jetpack Compose ã‚’å°å…¥ã—ã¦ã¿ã¾ã—ãŸï¼

è©¦ã—ã«å¼Šç¤¾ã®ã‚¢ãƒ—ãƒªã® KANNA ã«çµ„ã¿è¾¼ã‚“ã§ã¿ã¾ã—ãŸãŒå•é¡ŒãŒç™ºç”Ÿã—ãŸãŸã‚ã€ãã®éš›ã®å¯¾å¿œã‚‚å«ã‚ã¦å…±æœ‰ã§ãã‚Œã°ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

â€» ã‚‚ã—ä»Šå›ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã•ã‚Œã‚‹éš›ã¯ã‚ãã¾ã§è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™

# Jetpack Compose ã¨ã¯

[Jetpack Compose](https://developer.android.com/jetpack/compose) ã¨ã¯ Android ã§ UI ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚ React ã¨åŒæ§˜å®£è¨€çš„ UI ãŒç‰¹å¾´ã¨ãªã£ã¦ãŠã‚Šã€UI ãŒç°¡æ½”ã‹ã¤ç›´æ„Ÿçš„ã«è¨˜è¿°ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```kotlin:JetpackCompose.kt
@Composable
fun JetpackCompose() {
    Card {
        var expanded by remember { mutableStateOf(false) }
        Column(Modifier.clickable { expanded = !expanded }) {
            Image(painterResource(R.drawable.jetpack_compose))
            AnimatedVisibility(expanded) {
                Text(
                    text = "Jetpack Compose",
                    style = MaterialTheme.typography.bodyLarge
                )
            }
        }
    }
}
```

ä¸Šè¨˜ã¯ Jetpack Compose ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã™ãŒã€React ã‚’ä½¿ã£ãŸã“ã¨ãŒã‚ã‚‹æ–¹ã§ã‚ã‚Œã°ä½•ã¨ãªãèª­ã‚€ã“ã¨ã‚‚ã§ãã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

# Jetpack Compose ã‚’ä½¿ã†ãŸã‚ã®æ‰‹é †

React Native ã§ Jetpack Compose ã‚’å°å…¥ã™ã‚‹ãŸã‚ã®æ‰‹é †ã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã™ã€‚

1. Kotlin ã®å°å…¥
2. Jetpack Compose ã®å°å…¥
3. Jetpack Compose ã§ã® UI ä½œæˆ


## Kotlin ã®å°å…¥

Jetpack Compose ã‚’ä½¿ã†ã«ã¯ Kotlin ãŒå¿…é ˆã«ãªã‚Šã¾ã™ã€‚ ãã®ãŸã‚ Kotlin ã‚’å°å…¥ã—ã¦ã„ãªã„å ´åˆã¯ã€ã¾ãš Kotlin ã‚’å°å…¥ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```groovy:android/build.gradle
buildscript {
    dependencies {
        ...
        classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:1.8.10") // <- ã“ã®è¡Œã‚’è¿½åŠ 
    }
}
```

```groovy:android/app/build.gradle
apply plugin: "com.android.application"
apply plugin: "kotlin-android" // <- ã“ã®è¡Œã‚’è¿½åŠ 

```

å¾Œè¿°ã™ã‚‹ Compose ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã€ä½¿ç”¨å¯èƒ½ãª Kotlin ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯å›ºå®šã•ã‚Œã¾ã™ã€‚

Compose ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨å¯¾å¿œã™ã‚‹ Kotlin ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¡¨ãŒ [ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developer.android.com/jetpack/androidx/releases/compose-kotlin) ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

## Jetpack Compose ã®å°å…¥

ç¶šã„ã¦ Jetpack Compose ã®å°å…¥ã«ãªã‚Šã¾ã™ã€‚ ã¾ãšã¯ `android/app/build.gradle` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```groovy:android/app/build.gradle
android {
    ...
      
    buildFeatures {
        compose true
    }

    composeOptions {
        // Compose ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
        kotlinCompilerExtensionVersion = "1.4.3"
    }
}

dependencies {
    // Compose ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã¯ BOM ã‚’ä½¿ã†ã¨ä¾¿åˆ©
    // https://developer.android.com/jetpack/compose/bom/bom
    def composeBom = platform('androidx.compose:compose-bom:2023.01.00')
    implementation composeBom
  
    // Material Design 2
    implementation 'androidx.compose.material:material'
    
    // Android Studio Preview support
    implementation 'androidx.compose.ui:ui-tooling-preview'
    debugImplementation 'androidx.compose.ui:ui-tooling'
}
```

ä¸Šè¨˜ã§å°å…¥ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯æœ€ä½é™ã®ã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ã€‚ Compose ã§ä½¿ãˆã‚‹ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã©ã€ä»–ã«ã‚‚å°å…¥ã—ãŸã„å ´åˆã¯ [ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developer.android.com/jetpack/compose/setup) ã‚’å‚è€ƒã«ã—ã¦ã„ãŸã ãã®ãŒã‚ˆã„ã‹ã¨æ€ã„ã¾ã™ã€‚

ã¾ãŸæ³¨æ„ç‚¹ã¨ã—ã¦ä¸Šè¨˜ã«è¨˜è¼‰ã—ãŸ Compose ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ã†å ´åˆã€compileSdkVersion ãŒ33ä»¥é™ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ è¨­å®šè‡ªä½“ã¯ `android/app/build.gradle` ã«ã‚ã‚Šã¾ã™ãŒã€React Native ã‚¢ãƒ—ãƒªã‚’åˆæœŸä½œæˆã—ãŸæ™‚ã«ã¯ `android/build.gradle` ã«å¤‰æ•°å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```groovy:android/build.gradle
buildscript {
    ext {
        ...
        compileSdkVersion = 33 // <- 33 ã«æ›´æ–°ã™ã‚‹
        targetSdkVersion = 31
        ...
    }
    ...
}
```

ã“ã‚Œã§ Jetpack Compose ã®å°å…¥ã¯å®Œäº†ã«ãªã‚Šã¾ã™ã€‚

## Jetpack Compose ã§ã® UI ä½œæˆ

ç¶šã„ã¦ Jetpack Compose ã§ UI ã‚’ä½œæˆã—ã€ãã‚Œã‚’è¡¨ç¤ºã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚ Android ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã¯ [Native UI Components](https://reactnative.dev/docs/native-components-android) ã®æ©Ÿèƒ½ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ã“ã¡ã‚‰ã«ã¤ã„ã¦ã¯å…ˆæ—¥æŠ•ç¨¿ã—ãŸ [React Native ã® Native UI Components ã§ Android ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹](https://zenn.dev/aldagram_tech/articles/76f49e46e37cc1) ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ãŸã‚‰ã¨æ€ã„ã¾ã™ã€‚

ã¾ãšã¯ Android å´ã§ Compose ã‚’ä½¿ã†ãŸã‚ã® View ã‚’ä½œæˆã—ã¾ã™ã€‚

```kotlin:MyComposeView.kt
class MyComposeView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : AbstractComposeView(context, attrs, defStyleAttr) {
    @Composable
    override fun Content() {
        // ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã« Compose ã®ã‚³ãƒ¼ãƒ‰ãŒæ›¸ã‘ã‚‹
        Text(text = "Hello, Jetpack Compose!")
    }
}
```

`AbstractComposeView` ã‚’ç¶™æ‰¿ã—ãŸ View ã‚’ç”¨æ„ã—ã€`Content` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¾ã™ã€‚

Compose ã§ UI ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãéš›ã« `@Composable` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒä»˜ã„ãŸãƒ¡ã‚½ãƒƒãƒ‰ã¯ `@Composable` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒä»˜ã„ãŸãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã—ã‹å‘¼ã³å‡ºã›ãªã„ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚
`Content` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ `@Composable` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒä»˜ã„ã¦ã„ã‚‹ã®ã§ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã« UI ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãå½¢ã«ãªã‚Šã¾ã™ã€‚

ç¶šã„ã¦ `SimpleViewManager` ã‚’ç¶™æ‰¿ã—ãŸ `MyComposeViewManager` ã‚’ä½œã‚Šã¾ã™ã€‚

```kotlin:MyComposeViewManager.kt
class MyComposeViewManager : SimpleViewManager<MyComposeView>() {
    override fun getName(): String {
        // React Native å´ã§ View ã‚’å‚ç…§ã™ã‚‹éš›ã®åå‰
        return "MyComposeView"
    }

    override fun createViewInstance(context: ThemedReactContext): MyComposeView {
        return MyComposeView(context)
    }
}
```

`createViewInstance` ãƒ¡ã‚½ãƒƒãƒ‰ã§å…ˆã»ã©ä½œæˆã—ãŸ `MyComposeView` ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

ç¶šã„ã¦ä½œæˆã—ãŸ `MyComposeViewManager` ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

```kotlin:MyPackage.kt
class MyPackage : ReactPackage {
    override fun createNativeModules(context: ReactApplicationContext): List<NativeModule> {
        return emptyList()
    }

    override fun createViewManagers(context: ReactApplicationContext): List<ViewManager<*, *>> {
        return listOf(MyComposeViewManager())
    }
}
```

```java:MainApplication.java
public class MainApplication extends Application implements ReactApplication {

  private final ReactNativeHost mReactNativeHost =
      new ReactNativeHost(this) {
        @Override
        public boolean getUseDeveloperSupport() {
          return BuildConfig.DEBUG;
        }

        @Override
        protected List<ReactPackage> getPackages() {
          @SuppressWarnings("UnnecessaryLocalVariable")
          List<ReactPackage> packages = new PackageList(this).getPackages();
          packages.add(new MyPackage()); // <- ã“ã®è¡Œã‚’è¿½åŠ 
          return packages;
        }

  ...
```

ã“ã‚Œã§ Android å´ã®è¨­å®šã¯å®Œäº†ã—ãŸã®ã§ã€ç¶šã„ã¦ React Native å´ã«ãªã‚Šã¾ã™ã€‚

ã¾ãš MyComposeView ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«å®šç¾©ã—ã¾ã™ã€‚

```typescript:MyComposeView.ts
import { requireNativeComponent, ViewStyle } from 'react-native'

type MyComposeViewProps = Readonly<{
  style: ViewStyle
}>

export const MyComposeView =
  requireNativeComponent<MyComposeViewProps>('MyComposeView')
```

ãã—ã¦å®šç¾©ã—ãŸ MyComposeView ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã™ã‚Œã°å®Œæˆã§ã™ï¼

```typescript:App.tsx
import { StyleSheet } from 'react-native'
import { MyComposeView } from './MyComposeView'

const App = () => {
  return (
    <MyComposeView style={styles.compose} />
  )
}

const styles = StyleSheet.create({
  compose: {
    flex: 1
  }
});

export default App
```

ã“ã‚Œã§ React Native ã§ Compose ã‚’ä½¿ã£ã¦ UI ã‚’æç”»ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/5d77c293038f-20230314.png =320x)

# React Native ã‹ã‚‰å¤‰æ•°ã‚’æ¸¡ã—ã¦ Compose ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹

ã‚‚ã— React Native ã§ UI ã®è¡¨ç¤ºã«å¿…è¦ãªçŠ¶æ…‹ã‚’ç®¡ç†ã—ã¦ã„ã‚‹å ´åˆã€React Native ã‹ã‚‰ Android ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã«å¯¾ã—ã¦çŠ¶æ…‹ã‚’æ¸¡ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã« React Native å´ã§ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒ1ã¤ãšã¤å¢—ãˆã¦ã„ãå ´åˆã‚’è€ƒãˆã¾ã™ã€‚ 

```typescript:App.tsx
const App = () => {
  const [count, setCount] = useState(0)

  return (
    <>
      <MyComposeView style={styles.compose} />
      <Button 
        title='Increment' 
        onPress={() => setCount(prevCount => prevCount + 1)}
      />
    </>
  )
}
```

ã“ã®ã‚«ã‚¦ãƒ³ãƒˆã®å€¤ã‚’ Compose ã§è¡¨ç¤ºã•ã›ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚ React Native å´ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® props ã¨ã—ã¦è¨­å®šã•ã‚ŒãŸå€¤ã‚’å—ã‘å–ã‚‹ãŸã‚ã«ã€ã¾ãšã¯å…ˆã»ã©ä½œæˆã—ãŸ `MyComposeViewManager` ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

```kotlin:MyComposeViewManager.kt
class MyComposeViewManager : SimpleViewManager<MyComposeView>() {
    ...

    @ReactProp(name = "count")
    fun setCount(view: MyComposeView, count: Int) {
        view.setCount(count)
    }
}
```

props ã‚’å—ã‘å–ã‚‹ãŸã‚ã«ä¸Šè¨˜ã®ã‚ˆã†ã« `@ReactProp` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ãŸã‚»ãƒƒã‚¿ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨æ„ã—ã¾ã™ã€‚ ä»Šå›æ•°å€¤ã‚’å—ã‘å–ã‚‹ã®ã§å¼•æ•°ã®å‹ã¯ Int ã«ã—ã¦ã„ã¾ã™ã€‚

`MyComposeView` ã« `setCount` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨æ„ã—ã€ãã“ã«å€¤ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚ ç¶šã„ã¦ `MyComposeView` ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

```kotlin:MyComposeView.kt
class MyComposeView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : AbstractComposeView(context, attrs, defStyleAttr) {

    private val count: MutableState<Int> = mutableStateOf(0) // â‘ 

    @Composable
    override fun Content() {
        // â‘¡ ã§å€¤ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ UI ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œè¡¨ç¤ºãŒæ›´æ–°ã•ã‚Œã‚‹
        Text(text = "count = ${count.value}")
    }

    fun setCount(count: Int) {
        this.count.value = count // â‘¡
    }
}
```

ã“ã“ã§é‡è¦ãªã®ã¯ â‘  ã®éƒ¨åˆ†ã§ã™ã€‚ Compose ã§ã¯çŠ¶æ…‹ãŒå¤‰ã‚ã‚‹ã¨ UI ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€ã“ã®çŠ¶æ…‹ã¯ [State](https://developer.android.com/reference/kotlin/androidx/compose/runtime/State) ã®å¤‰æ•°ã§ç®¡ç†ã•ã‚Œã¾ã™ã€‚

State ã¯èª­ã¿å–ã‚Šå°‚ç”¨ã§ã™ãŒã€[MutableState](https://developer.android.com/reference/kotlin/androidx/compose/runtime/MutableState) ã¯å€¤ã®æ›´æ–°ãŒå¯èƒ½ã«ãªã£ã¦ãŠã‚Šã€[mutableStateOf](https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary#mutableStateOf(kotlin.Any,androidx.compose.runtime.SnapshotMutationPolicy)) ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã§å¤‰æ•°ã®ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚

ãªã®ã§â‘¡ã®éƒ¨åˆ†ã§ MutableState ã®å€¤ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ã€`Content` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ `count` ã‚’å‚ç…§ã—ã¦ã„ã‚‹ãŸã‚ UI ãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦è¡¨ç¤ºãŒæ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã¡ãªã¿ã«ã“ã® MutableState ã¯ã„ãã¤ã‹æ›¸ãæ–¹ãŒã‚ã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ï¼ˆè©³ç´°ã¯ [ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developer.android.com/jetpack/compose/state#state-in-composables) ã‚’å‚ç…§ï¼‰

```kotlin
// Kotlin ã® Delegated Propeties ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã„ã‚‹
// åˆ©ç”¨ã™ã‚‹éš›ã«ã¯ä»¥ä¸‹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ãŒå¿…è¦
// import androidx.compose.runtime.getValue
// import androidx.compose.runtime.setValue
private var count: Int by mutableStateOf(0)

// Kotlin ã® Destructuring Declarations ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã„ã‚‹
private val (count, setCount) = mutableStateOf(0)
```

ç¶šã„ã¦ React Native å´ã®å¤‰æ›´ã§ã™ã€‚ `MyComponentView` ã® props ã« count ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«å‹å®šç¾©ã—ã¾ã™ã€‚

```typescript:MyComponentView.ts
type MyComposeViewProps = Readonly<{
  count: number  // <- ã“ã®è¡Œã‚’è¿½åŠ 
  style: ViewStyle
}>
```

æœ€å¾Œã« `MyComponentView` ã® props ã« count ã‚’æ¸¡ã™ã‚ˆã†ã«ã™ã‚Œã°å®Œæˆã§ã™ã€‚

```typescript:App.tsx
const App = () => {
  const [count, setCount] = useState(0)

  return (
    <>
      <MyComposeView
        count={count}
        style={styles.compose}
      />
      <Button 
        title='Increment' 
        onPress={() => setCount(prevCount => prevCount + 1)}
      />
    </>
  )
}
```

![](https://storage.googleapis.com/zenn-user-upload/78a08d25091d-20230314.gif)


# ç™ºç”Ÿã—ãŸå•é¡Œ

æœ€åˆå¼Šç¤¾ã®ã‚¢ãƒ—ãƒªã«è©¦ã—ã«çµ„ã¿è¾¼ã‚€éš›ã«ã€å‰è¿°ã® `MyComposeViewManager` ã§è¨­å®šã™ã‚‹ãƒ“ãƒ¥ãƒ¼ã‚’ [ComposeView](https://developer.android.com/reference/kotlin/androidx/compose/ui/platform/ComposeView) ã‚’ä½¿ã£ã¦è©¦ã—ã¾ã—ãŸã€‚

ã™ã‚‹ã¨ Compose ã‚’ä½¿ã£ãŸç”»é¢ã®è¡¨ç¤ºæ™‚ã«ä»¥ä¸‹ã®ã‚ˆã†ãªä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

```
java.lang.IllegalStateException: Cannot locate windowRecomposer; View androidx.compose.ui.platform.ComposeView{65a64d6 V.E...... ......ID 0,0-0,0 #395} is not attached to a window
    at androidx.compose.ui.platform.WindowRecomposer_androidKt.getWindowRecomposer(WindowRecomposer.android.kt:294)
    at androidx.compose.ui.platform.AbstractComposeView.resolveParentCompositionContext(ComposeView.android.kt:240)
    at androidx.compose.ui.platform.AbstractComposeView.ensureCompositionCreated(ComposeView.android.kt:247)
    at androidx.compose.ui.platform.AbstractComposeView.onMeasure(ComposeView.android.kt:284)
    at android.view.View.measure(View.java:26358)
    at com.facebook.react.uimanager.NativeViewHierarchyManager.updateLayout(NativeViewHierarchyManager.java:189)
    at com.swmansion.reanimated.layoutReanimation.ReanimatedNativeHierarchyManager.updateLayout(ReanimatedNativeHierarchyManager.java:274)
    at com.facebook.react.uimanager.UIViewOperationQueue$UpdateLayoutOperation.execute(UIViewOperationQueue.java:169)
    at com.facebook.react.uimanager.UIViewOperationQueue$1.run(UIViewOperationQueue.java:915)
    at com.facebook.react.uimanager.UIViewOperationQueue.flushPendingBatches(UIViewOperationQueue.java:1026)
    at com.facebook.react.uimanager.UIViewOperationQueue.access$2600(UIViewOperationQueue.java:47)
    at com.facebook.react.uimanager.UIViewOperationQueue$DispatchUIFrameCallback.doFrameGuarded(UIViewOperationQueue.java:1086)
    at com.facebook.react.uimanager.GuardedFrameCallback.doFrame(GuardedFrameCallback.java:29)
    at com.facebook.react.modules.core.ReactChoreographer$ReactChoreographerDispatcher.doFrame(ReactChoreographer.java:175)
    at com.facebook.react.modules.core.ChoreographerCompat$FrameCallback$1.doFrame(ChoreographerCompat.java:85)
    at android.view.Choreographer$CallbackRecord.run(Choreographer.java:1229)
    at android.view.Choreographer$CallbackRecord.run(Choreographer.java:1239)
    at android.view.Choreographer.doCallbacks(Choreographer.java:899)
    at android.view.Choreographer.doFrame(Choreographer.java:827)
    at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:1214)
    at android.os.Handler.handleCallback(Handler.java:942)
    at android.os.Handler.dispatchMessage(Handler.java:99)
    at android.os.Looper.loopOnce(Looper.java:201)
    at android.os.Looper.loop(Looper.java:288)
    at android.app.ActivityThread.main(ActivityThread.java:7898)
    at java.lang.reflect.Method.invoke(Native Method)
    at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:548)
    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:936)
```

ã©ã†ã‚„ã‚‰ ComposeView ãŒ Window ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ãªãã€ä¾‹å¤–ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã‚ˆã†ã§ã—ãŸã€‚

ã“ã‚Œã¯ https://github.com/react-native-community/discussions-and-proposals/issues/446#issuecomment-1009532706 ã§ã‚³ãƒ¡ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹å•é¡Œã¨åŒã˜ã§ã€åŸå› ã«ã¤ã„ã¦ã‚‚ã“ã¡ã‚‰ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã©ã†ã‚„ã‚‰ ComposeView ã§ã¯ onMeasure() ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ Window ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€React Native ã§ã¯ `NativeViewHierarchyManager` ã¨ã„ã†ã‚¯ãƒ©ã‚¹å†…ã§ãƒ“ãƒ¥ãƒ¼ãŒ Window ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã§ãƒ“ãƒ¥ãƒ¼ã® measure ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã§ã„ã‚‹ãŸã‚ã€Window ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã§ã‚‚ onMeasure() ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚


## å¯¾å¿œç­–

ä¸Šè¨˜ã®ä¾‹å¤–ã¯ ComposeView ãŒ CompositionContext ã¨ã„ã†ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å‚ç…§ã§ããªã„ãŸã‚ã«ç™ºç”Ÿã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

https://github.com/react-native-community/discussions-and-proposals/issues/446#issuecomment-1010436438 ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå¯¾ç­–ã‚’è¡Œã„ã¾ã—ãŸã€‚

1. `AbstractComposeView` ã‚’ç¶™æ‰¿ã—ãŸã‚¹ã‚¿ãƒ–ã®ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè£…ã—ã€ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ãˆãªã„çŠ¶æ…‹ã«ã—ã¦ ReactRootView ã«ã‚ã‚‰ã‹ã˜ã‚ addView ã—ã¦ãŠã
2. `AbstractAppComposeView` ã‚’ä½œæˆã—ã€Compose ã§ã®ç”»é¢è¡¨ç¤ºã«ã¯ã“ã‚Œã‚’ç¶™æ‰¿ã—ãŸãƒ“ãƒ¥ãƒ¼ã‚’ä½¿ã†

:::details è£œè¶³
ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹åŸå› ã¯ ComposeView ãŒ CompositionContext ã¨ã„ã†ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å‚ç…§ã§ããªã„ãŸã‚ã«ç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚
CompositionContext ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ ComposeView ãŒã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã‚‹æ™‚ã«ä½œã‚‰ã‚Œã¾ã™ãŒã€å…ˆç¥–ã®ãƒ“ãƒ¥ãƒ¼ã§ã™ã§ã«ä½œã‚‰ã‚Œã¦ã„ã‚‹ã‚‚ã®ãŒã‚ã‚Œã°ãã‚ŒãŒåˆ©ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
ãªã®ã§ 1 ã§ã‚ã‚‰ã‹ã˜ã‚ addView ã—ã¦ãŠãã“ã¨ã«ã‚ˆã‚Š CompositionContext ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚‹ç›®çš„ã§ã“ã®å‡¦ç†ã‚’è¡Œãªã£ã¦ã„ã¾ã™
:::


1 ã«ã¤ã„ã¦ã¯ã€ã¾ãšä»¥ä¸‹ã®ã‚ˆã†ãªãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

```kotlin:StubComposeView.kt
class StubComposeView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : AbstractComposeView(context, attrs, defStyleAttr) {

    init {
        isVisible = false
    }

    @Composable
    override fun Content() {
    }
}
```

```java:MainActivity.java
@Override
protected ReactActivityDelegate createReactActivityDelegate() {
    return new ReactActivityDelegateWrapper(this,
        new ReactActivityDelegate(this, getMainComponentName()) {
            @Override
            protected ReactRootView createRootView() {
                final ReactRootView view = super.createRootView();
                view.addView(new StubComposeView(MainActivity.this)); // StubComposeView ã‚’ addView ã™ã‚‹
                return view;
            }
        }
    );
}
```

2 ã«ã¤ã„ã¦ã¯ã€ã¾ãš `AbstractAppComposeView` ã‚’ä½œæˆã—ã¾ã™ã€‚

```kotlin:AbstractAppComposeView.kt
abstract class AbstractAppComposeView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : AbstractComposeView(context, attrs, defStyleAttr) {

    init {
        // [WORKAROUND]
        // https://github.com/react-native-community/discussions-and-proposals/issues/446#issuecomment-1009532706
        // ViewManager ã® createViewInstance() ãƒ¡ã‚½ãƒƒãƒ‰ã§ ComposeView ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã¨ã€
        // ä¸Šè¨˜ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨åŒã˜ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã†.
        val compositionContext = findViewTreeCompositionContext()
            ?: context.findActivity()?.findViewById<ViewGroup>(android.R.id.content)
                ?.children
                ?.mapNotNull { it.findViewTreeCompositionContext() }
                ?.firstOrNull()
        setParentCompositionContext(compositionContext)
    }
}
```

ãã—ã¦ Compose ã‚’ä½¿ã†ç”»é¢ã§ã¯ã“ã®ãƒ“ãƒ¥ãƒ¼ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¦ã€Compose ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

```kotlin:MyComposeView.kt
class MyComposeView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : AbstractAppComposeView(context, attrs, defStyleAttr) {
    @Composable
    override fun Content() {
        ...
    }
}
```

ã“ã‚Œã§ Compose ã®ç”»é¢ã‚’è¡¨ç¤ºã—ã¦ã‚‚ä¾‹å¤–ãŒç™ºç”Ÿã—ãªããªã‚Šã¾ã™ã€‚
ã“ã®å¯¾ç­–ã‚’è¡Œã†ã“ã¨ã§ç‰¹ã«è¿½åŠ ã§å•é¡Œã¯ç™ºç”Ÿã—ã¦ã„ã¾ã›ã‚“ãŒã€æ­£ã—ã„å¯¾ç­–ã‹ã©ã†ã‹ã¯ä¸æ˜ã®ãŸã‚å‚è€ƒã«ã™ã‚‹éš›ã«ã¯ã‚ãã¾ã§è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚

ä»¥ä¸ŠãŒè¡Œã£ãŸå¯¾ç­–ã«ãªã‚Šã¾ã™ã€‚

# æœ€å¾Œã«

ã¡ãªã¿ã«å…ˆã»ã©ã®ä¾‹å¤–ã«ã¤ã„ã¦ã¯æ­£ç›´ç™ºç”Ÿæ¡ä»¶ãŒã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦ã¿ã¦è©¦ã—ã¦ã‚‚ä¾‹å¤–ãŒç™ºç”Ÿã—ãªã‹ã£ãŸã®ã§ã€React Native ã§ä½¿ã£ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã©ã‚‚é–¢ä¿‚ã—ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã©ãªãŸã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ï¼
